<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lecture Transcriber with Gemini</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f4f4f9; }
    h1 { color: #333; }
    textarea { width: 100%; height: 150px; margin-top: 1em; }
    button { margin: 0.5em 0.2em; padding: 0.6em 1em; }
    #transcription { background: #fff; padding: 1em; border: 1px solid #ccc; min-height: 200px; }
  </style>
</head>
<body>
  <h1>Lecture Recorder + Gemini Transcriber</h1>

  <div>
    <label for="apiKey">Gemini API Key:</label>
    <input type="password" id="apiKey" placeholder="Enter once, saved locally">
    <button onclick="saveKey()">Save</button>
  </div>

  <div>
    <button id="recordBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <input type="file" id="audioUpload" accept="audio/*">
  </div>

  <h3>Transcription</h3>
  <div id="transcription">Nothing yetâ€¦</div>

  <script>
    let mediaRecorder, audioChunks = [];

    // Save key locally
    function saveKey() {
      const key = document.getElementById("apiKey").value;
      if (key) {
        localStorage.setItem("gemini_api_key", key);
        alert("API Key saved locally!");
      }
    }

    // Recorder setup
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    recordBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        sendToGemini(audioBlob);
      };
      mediaRecorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    };
    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // Upload handler
    document.getElementById("audioUpload").onchange = (e) => {
      const file = e.target.files[0];
      if (file) sendToGemini(file);
    };

    async function sendToGemini(audioBlob) {
      const apiKey = localStorage.getItem("gemini_api_key");
      if (!apiKey) {
        alert("Please enter and save your Gemini API key first.");
        return;
      }

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Audio = reader.result.split(",")[1];

        const requestBody = {
          contents: [
            {
              parts: [
                { file_data: { mime_type: audioBlob.type || "audio/webm", file_uri: `data:${audioBlob.type};base64,${base64Audio}` } },
                { text: "Transcribe this audio to text." }
              ]
            }
          ]
        };

        try {
          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=" + apiKey, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
          });

          const data = await response.json();
          console.log("Gemini response:", data);

          const transcription = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Transcription failed.";
          document.getElementById("transcription").innerText = transcription;
        } catch (err) {
          console.error(err);
          document.getElementById("transcription").innerText = "Error: " + err.message;
        }
      };
      reader.readAsDataURL(audioBlob);
    }
  </script>
</body>
</html>