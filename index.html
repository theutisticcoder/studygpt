<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lecture Recorder + Gemini AI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0; padding: 20px;
      color: #333;
    }
    h1 { color: #444; }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      margin: 5px; padding: 10px 20px;
      background: #0077ff; color: white;
      border: none; border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
    textarea, input {
      width: 100%; padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    audio { margin-top: 10px; width: 100%; }
    .output {
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 10px; border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Lecture Recorder + Gemini AI</h1>

    <label>Gemini API Key:</label>
    <input type="password" id="apiKeyInput" placeholder="Enter Gemini API key">

    <button onclick="saveApiKey()">Save API Key</button>
    <hr>

    <h2>Record a Lecture</h2>
    <button id="recordBtn">Start Recording</button>
    <audio id="audioPlayback" controls></audio>

    <h2>Or Upload MP3</h2>
    <input type="file" id="audioUpload" accept="audio/mp3,audio/wav">

    <h2>Transcript</h2>
    <div id="transcript" class="output"></div>

    <h2>AI Actions</h2>
    <button onclick="summarizeTranscript()">Summarize</button>
    <textarea id="questionInput" placeholder="Ask a question about the lecture..."></textarea>
    <button onclick="askQuestion()">Ask</button>

    <h2>AI Response</h2>
    <div id="aiResponse" class="output"></div>
  </div>

<script>
let mediaRecorder, audioChunks = [];

// Load saved API key
document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || '';

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value;
  localStorage.setItem('gemini_api_key', key);
  alert("API key saved locally!");
}

document.getElementById("recordBtn").addEventListener("click", async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const audioURL = URL.createObjectURL(blob);
      document.getElementById("audioPlayback").src = audioURL;
      await transcribeAudio(blob);
    };

    mediaRecorder.start();
    document.getElementById("recordBtn").innerText = "Stop Recording";
  } else {
    mediaRecorder.stop();
    document.getElementById("recordBtn").innerText = "Start Recording";
  }
});

document.getElementById("audioUpload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (file) await transcribeAudio(file);
});

async function transcribeAudio(file) {
  const apiKey = localStorage.getItem('gemini_api_key');
  if (!apiKey) { alert("Please enter and save your Gemini API key!"); return; }

  const base64Audio = await fileToBase64(file);
  const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{
        parts: [
          { text: "Please transcribe this audio into text:" },
          { inlineData: { mimeType: file.type, data: base64Audio.split(",")[1] } }
        ]
      }]
    })
  });

  const data = await response.json();
  const transcript = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Transcription failed.";
  document.getElementById("transcript").innerText = transcript;
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = err => reject(err);
  });
}

async function summarizeTranscript() {
  const transcript = document.getElementById("transcript").innerText;
  if (!transcript) return alert("No transcript available!");

  const apiKey = localStorage.getItem('gemini_api_key');
  const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: "Summarize this lecture:\n" + transcript }] }]
    })
  });

  const data = await response.json();
  document.getElementById("aiResponse").innerText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Summary failed.";
}

async function askQuestion() {
  const transcript = document.getElementById("transcript").innerText;
  const question = document.getElementById("questionInput").value;
  if (!transcript || !question) return alert("Need both transcript and question!");

  const apiKey = localStorage.getItem('gemini_api_key');
  const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      contents: [{ parts: [{ text: "Based on this lecture transcript:\n" + transcript + "\nAnswer: " + question }] }]
    })
  });

  const data = await response.json();
  document.getElementById("aiResponse").innerText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Q&A failed.";
}
</script>
</body>
</html>