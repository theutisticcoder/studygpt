<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lecture Recorder + AI Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f8f8; color: #333; }
    h1 { color: #444; }
    textarea, input, button { width: 100%; margin: 5px 0; padding: 10px; }
    #transcript, #aiOutput { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: auto; }
    .row { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Lecture Recorder + AI Assistant</h1>

  <!-- API Key -->
  <div class="row">
    <input id="apiKey" type="password" placeholder="Enter Gemini API Key">
    <button onclick="saveApiKey()">Save API Key</button>
  </div>

  <!-- Recording -->
  <div class="row">
    <button id="recordBtn">üéô Start Recording</button>
    <button onclick="stopRecording()">‚èπ Stop</button>
  </div>

  <!-- Upload -->
  <div class="row">
    <input type="file" id="fileInput" accept="audio/mp3">
    <button onclick="uploadFile()">Upload MP3</button>
  </div>

  <h3>Transcript</h3>
  <div id="transcript"></div>

  <h3>Ask AI</h3>
  <textarea id="question" placeholder="Ask about the lecture..."></textarea>
  <button onclick="askAI()">Ask</button>
  <button onclick="summarize()">Summarize Lecture</button>

  <h3>AI Output</h3>
  <div id="aiOutput"></div>

  <script>
    let mediaRecorder;
    let chunks = [];
    let transcriptText = "";

    // Save and load API key from localStorage
    document.getElementById("apiKey").value = localStorage.getItem("gemini_api_key") || "";
    function saveApiKey() {
      const key = document.getElementById("apiKey").value;
      localStorage.setItem("gemini_api_key", key);
      alert("API key saved locally.");
    }

    // Recording
    document.getElementById("recordBtn").addEventListener("click", async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        await transcribeAudio(blob);
      };
      mediaRecorder.start(2000); // Collect chunks every 2s
      document.getElementById("recordBtn").disabled = true;

      // Live transcription chunks
      mediaRecorder.ondataavailable = async (e) => {
        if (e.data.size > 0) {
          await transcribeAudio(e.data, true);
        }
      };
    });

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        document.getElementById("recordBtn").disabled = false;
      }
    }

    // Upload MP3
    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (file) await transcribeAudio(file);
    }

    // Transcription with Gemini
    async function transcribeAudio(audioBlob, append = false) {
      const key = localStorage.getItem("gemini_api_key");
      if (!key) { alert("Enter API key first"); return; }

      const formData = new FormData();
      formData.append("file", audioBlob, "audio.mp3");

      const resp = await fetch(
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:transcribe?key=" + key,
        { method: "POST", body: formData }
      );

      const data = await resp.json();
      if (data.transcript) {
        if (append) transcriptText += " " + data.transcript;
        else transcriptText = data.transcript;
        document.getElementById("transcript").innerText = transcriptText;
      } else {
        console.error(data);
        document.getElementById("transcript").innerText += "\n[Error transcribing]";
      }
    }

    // Ask AI
    async function askAI() {
      const key = localStorage.getItem("gemini_api_key");
      if (!key) { alert("Enter API key first"); return; }
      const question = document.getElementById("question").value;
      const prompt = `Here is a lecture transcript:\n${transcriptText}\n\nQuestion: ${question}`;
      await queryGemini(prompt);
    }

    async function summarize() {
      const key = localStorage.getItem("gemini_api_key");
      if (!key) { alert("Enter API key first"); return; }
      const prompt = `Summarize this lecture clearly:\n${transcriptText}`;
      await queryGemini(prompt);
    }

    async function queryGemini(prompt) {
      const key = localStorage.getItem("gemini_api_key");
      const resp = await fetch(
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + key,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        }
      );
      const data = await resp.json();
      if (data.candidates && data.candidates[0].content.parts[0].text) {
        document.getElementById("aiOutput").innerText = data.candidates[0].content.parts[0].text;
      } else {
        console.error(data);
        document.getElementById("aiOutput").innerText = "[Error with AI response]";
      }
    }
  </script>
</body>
</html>