<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lecture Recorder + AI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h1 { text-align: center; }
    button { margin: 5px; padding: 10px 15px; }
    textarea {
      width: 100%;
      height: 150px;
      margin-top: 10px;
      padding: 10px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Lecture Recorder + AI</h1>

  <div>
    <label>Gemini API Key: </label>
    <input type="password" id="apiKeyInput" placeholder="Enter API key" />
    <button onclick="saveApiKey()">Save Key</button>
  </div>

  <div>
    <button id="startRec">üéôÔ∏è Start Recording</button>
    <button id="stopRec" disabled>‚èπÔ∏è Stop Recording</button>
    <input type="file" id="uploadFile" accept="audio/mp3" />
  </div>

  <h3>Transcript:</h3>
  <textarea id="transcript"></textarea>

  <h3>Ask AI:</h3>
  <textarea id="question" placeholder="Ask about the lecture..."></textarea>
  <button onclick="askAI()">Ask</button>

  <h3>Answer:</h3>
  <textarea id="answer"></textarea>

  <h3>Summary:</h3>
  <button onclick="summarize()">Summarize Lecture</button>
  <textarea id="summary"></textarea>

  <script>
    // ==== LocalStorage API Key ====
    const apiKeyInput = document.getElementById("apiKeyInput");
    const storedKey = localStorage.getItem("gemini_api_key");
    if (storedKey) apiKeyInput.value = storedKey;

    function saveApiKey() {
      localStorage.setItem("gemini_api_key", apiKeyInput.value);
      alert("API key saved!");
    }

    // ==== Transcript handling ====
    const transcriptBox = document.getElementById("transcript");
    let recognition;
    let recognizing = false;

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = "en-US";

      recognition.onresult = (event) => {
        let finalText = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalText += transcript + " ";
          }
        }
        transcriptBox.value += finalText;
      };
    } else {
      alert("Web Speech API not supported in this browser!");
    }

    document.getElementById("startRec").onclick = () => {
      if (!recognizing) {
        recognition.start();
        recognizing = true;
        document.getElementById("startRec").disabled = true;
        document.getElementById("stopRec").disabled = false;
      }
    };

    document.getElementById("stopRec").onclick = () => {
      if (recognizing) {
        recognition.stop();
        recognizing = false;
        document.getElementById("startRec").disabled = false;
        document.getElementById("stopRec").disabled = true;
      }
    };

    // ==== MP3 Upload (playback + re-transcribe) ====
    document.getElementById("uploadFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const audio = new Audio(URL.createObjectURL(file));
        audio.play();
        recognition.start();
        audio.onended = () => recognition.stop();
      }
    });

    // ==== Gemini AI Calls ====
    async function callGemini(prompt) {
      const apiKey = localStorage.getItem("gemini_api_key");
      if (!apiKey) {
        alert("Please save your Gemini API key first!");
        return "";
      }

      const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + apiKey, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      const data = await response.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
    }

    async function askAI() {
      const q = document.getElementById("question").value;
      const text = transcriptBox.value;
      const ans = await callGemini("Lecture content: " + text + "\n\nQuestion: " + q);
      document.getElementById("answer").value = ans;
    }

    async function summarize() {
      const text = transcriptBox.value;
      const summary = await callGemini("Summarize this lecture:\n\n" + text);
      document.getElementById("summary").value = summary;
    }
  </script>
</body>
</html>